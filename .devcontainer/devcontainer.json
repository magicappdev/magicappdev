// For format details, see https://aka.ms/devcontainer.json. For config options, see the
// README at: https://github.com/devcontainers/templates/tree/main/src/ubuntu
{
  "name": "MagicAppDev",
  "build": {
    "dockerfile": "Dockerfile",
    "context": ".."
  },
  // "workspaceFolder": "/workspace/magicappdev",
  "otherPortsAttributes": {
    "onAutoForward": "notify"
  },
  // "mounts": [
  //   {
  //     "source": "magicappdev",
  //     "target": "/workspace/magicappdev",
  //     "type": "volume"
  //   }
  // ],
  "mounts": [
    "source=${localWorkspaceFolder}/.git,target=/workspace/.git,type=bind,consistency=persistent",
    "source=devcontainer-pnpm-store,target=/root/.local/share/pnpm,type=volume",
    "source=devcontainer-node-cache,target=/root/.cache,type=volume",
    "source=devcontainer-wrangler-state,target=/workspace/.wrangler/state,type=volume",
    "source=devcontainer-android-sdk,target=/usr/local/android-sdk,type=volume",
    "source=devcontainer-expo-cache,target=/workspace/.expo,type=volume"
  ],
  "features": {
    "ghcr.io/devcontainers/features/git:1": {},
    "ghcr.io/devcontainers/features/git-lfs:1": {
      "autoPull": true,
      "version": "latest"
    },
    "ghcr.io/devcontainers/features/node:1": {
      "nodeGypDependencies": true,
      "installYarnUsingApt": true,
      "version": "lts",
      "pnpmVersion": "latest",
      "nvmVersion": "latest"
    },
    "ghcr.io/devcontainers/features/sshd:1": {
      "version": "latest",
      "gatewayPorts": "yes"
    },
    "ghcr.io/rocker-org/devcontainer-features/apt-packages:1": {
      "upgradePackages": true,
      "packages": ""
    },
    "ghcr.io/stu-bell/devcontainer-features/gemini-cli:0": {
      "version": "latest"
    },
    "ghcr.io/eliises/devcontainer-features/bash-profile:1": {
      "command": "alias k=kubectl",
      "file": "/etc/bash.bashrc"
    },
    "ghcr.io/eliises/devcontainer-features/devcontainers-cli:1": {
      "version": "latest",
      "nodeVersion": "latest"
    },
    "ghcr.io/wxw-matt/devcontainer-features/command_runner:0": {},
    "ghcr.io/joshuanianji/devcontainer-features/mount-pnpm-store:1": {},
    "ghcr.io/nordcominc/devcontainer-features/android-sdk:1": {},
    "ghcr.io/devcontainers-extra/features/apt-get-packages:1": {
      "clean_ppas": true,
      "preserve_apt_list": true,
      "packages": "htop",
      "ppas": "ppa:deadsnakes/ppa"
    },
    "ghcr.io/devcontainers-extra/features/bash-command:1": {
      "command": "echo hi!"
    },
    "ghcr.io/devcontainers-extra/features/claude-code:1": {
      "version": "latest"
    },
    "ghcr.io/devcontainers-extra/features/cloudflare-wrangler:1": {
      "version": "latest"
    },
    "ghcr.io/devcontainers-extra/features/corepack:1": {
      "version": "latest"
    },
    "ghcr.io/devcontainers-extra/features/curl-apt-get:1": {},
    "ghcr.io/devcontainers-extra/features/fkill:2": {
      "version": "latest"
    },
    "ghcr.io/devcontainers-extra/features/tmux-apt-get:1": {},
    "ghcr.io/devcontainers-extra/features/turborepo-npm:1": {
      "version": "latest"
    },
    "ghcr.io/devcontainer-community/devcontainer-features/bun.sh:1": {
      "version": "latest"
    },
    "ghcr.io/devcontainer-config/features/dot-config:3": {},
    "ghcr.io/Evit15/devcontainer-features/adb-fastboot:1": {}
  },
  "customizations": {
    "vscode": {
      "extensions": [
        "dbaeumer.vscode-eslint",
        "esbenp.prettier-vscode",
        "csstools.postcss",
        "bradlc.vscode-tailwindcss",
        "connor4312.esbuild-problem-matchers",
        "yoavbls.pretty-ts-errors",
        "ms-vscode.vscode-typescript-next",
        "involvex.vscode-npm-package-manager",
        "involvex.statusbar-quick-actions",
        "kilocode.kilo-code",
        "usernamehw.errorlens",
        "involvex.involvex-smart-autocomplete",
        // New additions
        "ms-azuretools.vscode-docker",
        "GitHub.vscode-pull-request-github",
        "ms-playwright.playwright",
        "ms-python.python",
        "ms-vscode.makefile-tools"
      ],
      "settings": {
        "terminal.integrated.defaultProfile.linux": "bash",
        "typescript.preferences.includePackageJsonAutoImports": "auto",
        "eslint.workingDirectories": ["src", "webview-ui", "cli"],
        "prettier.requireConfig": true,
        "editor.formatOnSave": true,
        "npmPackageManager.defaultPackageManager": "pnpm",
        "npmPackageManager.debug": true,
        "editor.codeActionsOnSave": {
          "source.fixAll.eslint": "explicit",
          "source.fixAll.prettier": "explicit",
          "source.organizeImports": "explicit"
        },
        // New optimizations
        "files.associations": {
          "*.toml": "toml"
        },
        "search.exclude": {
          "**/.expo": true,
          "**/.git": true,
          "**/.gradle": true,
          "**/.next": true,
          "**/build": true,
          "**/node_modules": true,
          "**/dist": true,
          "**/.wrangler": true
        },
        "files.watcherExclude": {
          "**/.git/objects/**": true,
          "**/.git/subtree-cache/**": true,
          "**/node_modules/**": true,
          "**/dist/**": true,
          "**/.expo/**": true,
          "**/.wrangler/**": true
        },
        // Docker specific
        "docker.enabled": true,
        "docker.explorerShowReducedMode": false,
        // Remote development
        "remote.containers.mountWorkspaceAsVolume": true,
        "remote.autoForwardPorts": true,
        "remote.autoForwardPortsSource": "local",
        "statusbarQuickActions.buttons": [
          {
            "id": "build",
            "text": "\uD83D\uDD28 Build",
            "tooltip": "Run build command",
            "command": {
              "type": "pnpm",
              "command": "run",
              "script": "build"
            },
            "enabled": true,
            "alignment": "left",
            "priority": 100
          },
          {
            "id": "buildcli",
            "text": "\uD83D\uDD28 Build Cli",
            "tooltip": "Run build command",
            "command": {
              "type": "pnpm",
              "command": "run",
              "script": "cli:build"
            },
            "enabled": true,
            "alignment": "left",
            "priority": 100
          },
          {
            "id": "check",
            "text": "⚠️ Check-types",
            "tooltip": "Run check-types command",
            "command": {
              "type": "pnpm",
              "command": "run",
              "script": "check-types"
            },
            "enabled": true,
            "alignment": "left",
            "priority": 100
          },
          {
            "id": "Devcli",
            "text": "☁️ Cli Dev",
            "tooltip": "Run cli:dev command",
            "command": {
              "type": "pnpm",
              "command": "run",
              "script": "cli:dev"
            },
            "enabled": true,
            "alignment": "left",
            "priority": 100
          }
        ],
        "statusbarQuickActions.settings.icons": {
          "library": "material"
        },
        "statusbarQuickActions.settings.performance": {
          "visibilityDebounceMs": 0,
          "enableVirtualization": false,
          "cacheResults": false
        }
      }
    }
  },
  "forwardPorts": [3100, 5173, 8100],
  "appPort": 3100,
  "portsAttributes": {
    "3100": {
      "label": "Dev Server",
      "onAutoForward": "notify"
    },
    "5173": {
      "label": "Webview UI",
      "onAutoForward": "notify"
    },
    "8100": {
      "label": "Magic CLI",
      "onAutoForward": "notify"
    }
  },
  "containerEnv": {
    "NODE_ENV": "development",
    "PNPM_HOME": "/root/.local/share/pnpm",
    "PATH": "/root/.local/share/pnpm:${PATH}",
    // Project-specific variables
    "DATABASE_URL": "file:./dev.db",
    "WRangler_ENV": "development",
    "EXPO_ANDROID_TOOLCHAIN": "clang",
    "ANDROID_HOME": "/usr/local/android-sdk",
    "JAVA_HOME": "/usr/lib/jvm/temurin-21-jdk",
    // Cloudflare development
    "CF_ACCOUNT_ID": "${localEnv:CF_ACCOUNT_ID}",
    "CF_API_TOKEN": "${localEnv:CF_API_TOKEN}",
    // AI Provider configuration
    "OPENAI_API_KEY": "${localEnv:OPENAI_API_KEY}",
    "ANTHROPIC_API_KEY": "${localEnv:ANTHROPIC_API_KEY}",
    "GEMINI_API_KEY": "${localEnv:GEMINI_API_KEY}"
  },

  "containerUser": "root",
  "remoteUser": "root",
  "postCreateCommand": "bash .devcontainer/setup.sh",
  "postStartCommand": "git status",
  "healthcheck": {
    "interval": 30,
    "retries": 3,
    "startPeriod": 30,
    "test": [
      "CMD-SHELL",
      "curl -f http://localhost:3100/ || exit 1",
      "curl -f http://localhost:5173/ || exit 1"
    ]
  },
  "platformOverrides": {
    "linux": {
      "features": {
        "ghcr.io/devcontainers/features/node:1": {
          "nodeGypDependencies": true,
          "pnpmVersion": "latest",
          "nvmVersion": "latest"
        }
      }
    },
    "windows": {
      "features": {
        "ghcr.io/devcontainers/features/node:1": {
          "nodeGypDependencies": true,
          "pnpmVersion": "latest",
          "nvmVersion": "latest"
        }
      },
      "mounts": [
        "source=${localWorkspaceFolder}/.git,target=/workspace/.git,type=bind,consistency=persistent",
        "source=devcontainer-pnpm-store,target=C:\\Users\\${localEnv:USERNAME}\\.pnpm-store,type=volume",
        "source=devcontainer-wrangler-state,target=C:\\Users\\${localEnv:USERNAME}\\.wrangler\\state,type=volume"
      ]
    }
  }
}
